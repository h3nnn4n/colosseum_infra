---
- name: Add deadsnakes ppa
  ansible.builtin.apt_repository:
    repo: 'ppa:deadsnakes/ppa'

- name: Refresh apt and install base packages
  apt:
    pkg:
      - file
      - htop
      - liblzma-dev  # Necessary to handle xz files
      - libmagic1  # For mime detection
      - neovim
      - prometheus-node-exporter
      - python-is-python3
      - python3.10-full
      - sudo
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: Ensure python3 is python3.10
  ansible.builtin.command: "update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 10"

- name: Ensure python-apt is present
  apt:
    pkg:
      - python-apt
      - python3-apt
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: Make sure we have a 'wheel' group
  group:
    name: wheel
    state: present

- name: Allow 'wheel' group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'

- name: Add devops user
  user:
    name: devops
    groups: wheel
    append: yes
    state: present
    createhome: yes
    shell: /bin/bash

- name: Set authorized keys
  ansible.posix.authorized_key:
    user: devops
    state: present
    key: "{{ lookup('file', 'authorized_keys') }}"
    exclusive: True

- name: Ensure ssh login password is disabled
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^(.*)PasswordAuthentication(.*)$'
    line: 'PasswordAuthentication no'

- name: Restart ssh
  ansible.builtin.service:
    name: sshd
    state: restarted

- name: Setup poetry
  ansible.builtin.shell: |
    python3.10 -m ensurepip
    python3.10 -m pip install poetry
  become: yes
  become_method: sudo
  become_user: devops
  vars:
    allow_world_readable_tmpfiles: true

- name: Ensure prometheus-node-exporter is started
  service: name=prometheus-node-exporter state=started enabled=yes
